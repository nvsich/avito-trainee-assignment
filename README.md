# **Merch shop system**

Микросервис для сотрудников, позволяющий покупать товары в магазине, обмениваться монетками между пользователями и получать информацию о пользователях.

## Используемые технологии:
* База данных - `PostgreSQL`
* Миграции - `golang-migrate/migrate`
* Управление БД - `pgxpool`
* Менеджер транзакций - `avito-tech/go-transaction-manager`
* Router - `chi router`
* Развертывание - `Docker`
* Тестирование - `testify`, `mock`, `testcontainers`
* Архитектура - `Clean Architecture`

## Запуск
Запустить сервис можно с помощью команды `make run-build`

Запустить тестовую среду для e2e тестирования: 1) запуск БД и миграций `make e2e-stand` , 2) запуск приложения `go run ./cmd/app --env-path=local.e2e.env`

Запустить тесты - `make test`

Запустить тесты с покрытием - `make test-cover`

Тестовая среда для интеграционных тестов создается с помощью `go-testcontainers`

## Нагрузочное тестирование
Выполнялось с помощью k6
```
http_req_blocked...............: avg=1.25ms  min=0s   med=0s    max=28.05ms  p(90)=1.9ms    p(95)=6.66ms
http_req_connecting............: avg=1.2ms   min=0s   med=0s    max=28.05ms  p(90)=1.55ms   p(95)=6.66ms
http_req_duration..............: avg=1.31s   min=13ms med=1.22s max=3.64s    p(90)=3.33s    p(95)=3.44s
  { expected_response:true }...: avg=1.31s   min=13ms med=1.22s max=3.64s    p(90)=3.33s    p(95)=3.44s
http_req_failed................: 0.00%   0 out of 200
http_req_receiving.............: avg=5.26ms  min=0s   med=0s    max=246.47ms p(90)=999.53µs p(95)=6.59ms
http_req_sending...............: avg=57.96µs min=0s   med=0s    max=1ms      p(90)=0s       p(95)=515.75µs
http_req_tls_handshaking.......: avg=0s      min=0s   med=0s    max=0s       p(90)=0s       p(95)=0s
http_req_waiting...............: avg=1.31s   min=13ms med=1.22s max=3.64s    p(90)=3.26s    p(95)=3.44s
```

## Проблемы, возникшие в ходе решения

 1) **Управление транзакциями**

    Возникла проблема с управлением транзакциями - как сделать бизнес логику транзакционной? Был вариант "перегрузить" репозитории и скинуть на нее большую часть бизнес логики, но тогда бы сломался подход чистой архитектуры. Решение - использование транзакционного менеджера - avito-tech/go-transaction-manager - на сервисном слое.
 

 2) **Неописанный в условии функционал**
    
    В решении реализовано ровно столько функционала, сколько просится в условии. Именно поэтому, например, заполнение магазина мерчом происходит в скрипте миграций.
